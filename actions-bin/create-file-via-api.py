import sys
import os
import json
import base64
import requests

g_api_key = os.environ["G_WRITE_API_KEY"]
filename = sys.argv[1]
contributor = sys.argv[2]
basename = os.path.basename(filename)

content = ""
with open(filename) as input_f:
    content = input_f.read()

base_url = "https://api.github.com/repos/"
primary_repo = "CVEProject/cve-reference-ingest"
full_url = f"{base_url}{primary_repo}/contents/references/{contributor}-{basename}"

headers = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28",
    "Authorization": f"Bearer {g_api_key}",
}

# Comment to trigger demo
json_data = {"message": "a contributed reference"}

base64_original = base64.b64encode(content + "\n")

print("Original:\n" + base64_original)
base64_lines = base64_original.split("\n")

base64_data = "".join(base64_lines)

print('all on one line: "' + base64_data + '"')
json_data["content"] = base64_data

json_string = json.dumps(json_data)
response = requests.put(full_url, headers=headers, data=json_string)

status_code = response.status_code
if status_code != 201:
    print("failed to add " + full_url + " via API: " + str(status_code) + str(response.reason) + str(response.text))
    exit()

print(filename + " added: " + content)
